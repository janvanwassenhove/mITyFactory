# Infrastructure as Code Quality Policy
# Applies to applications with IaC enabled

id: iac-quality
name: IaC Quality Policy
description: |
  Quality gate policy for Infrastructure as Code.
  Enforces Terraform validation and security scanning.
version: "1.0.0"

# This policy applies to all templates (when IaC is enabled)
applies_to:
  - "*"

severity: error
allow_skip: false

checks:
  # Terraform format check
  - id: terraform-fmt
    name: Terraform Format
    description: Check Terraform files are properly formatted
    check_type: custom_command
    required: true
    severity: warning
    config:
      command: terraform
      args:
        - fmt
        - -check
        - -recursive
      container: hashicorp/terraform:1.6
      workdir: infrastructure
      timeout_seconds: 120
      allow_failure: true

  # Terraform validation
  - id: terraform-validate
    name: Terraform Validate
    description: Validate Terraform configuration
    check_type: iac_validate
    required: true
    severity: error
    config:
      container: hashicorp/terraform:1.6
      workdir: infrastructure
      timeout_seconds: 300

  # Terraform init
  - id: terraform-init
    name: Terraform Init
    description: Initialize Terraform working directory
    check_type: custom_command
    required: true
    severity: error
    config:
      command: terraform
      args:
        - init
        - -backend=false
      container: hashicorp/terraform:1.6
      workdir: infrastructure
      timeout_seconds: 300

  # Secrets in IaC
  - id: iac-secrets-scan
    name: IaC Secrets Scan
    description: Scan IaC files for hardcoded secrets
    check_type: secrets_scan
    required: true
    severity: critical
    config:
      patterns:
        - "**/*.tf"
        - "**/*.tfvars"
        - "**/*.hcl"

  # TFSec security scan (placeholder)
  - id: tfsec-scan
    name: TFSec Security Scan
    description: Run tfsec to check for security issues
    check_type: security_scan
    required: false
    severity: warning
    config:
      command: tfsec
      args:
        - .
      container: aquasec/tfsec:latest
      workdir: infrastructure
      timeout_seconds: 300
      allow_failure: true

rules:
  - rule_id: no-secrets
    severity: critical
